{% extends "base.html" %}
{% block content %}
<div style="max-width: 800px;">
    <h2>‚úèÔ∏è Editar Turno</h2>

    <form method="post" style="background: var(--bg-card); border: 2px solid var(--accent); border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(200, 155, 143, 0.15);">
        {% csrf_token %}
        
        <!-- Agenda -->
        <div style="margin-bottom: 1.5rem;">
            <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Agenda</label>
            <select name="agenda" id="id_agenda" required style="width: 100%; background: #ffffff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;">
                {% for agenda in agendas %}
                    <option value="{{ agenda.id }}" {% if agenda.id == turno.agenda.id %}selected{% endif %}>{{ agenda.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- DNI (No editable) -->
        <div style="margin-bottom: 1.5rem;">
            <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">DNI</label>
            <input type="text" value="{% if paciente %}{{ paciente.dni }}{% else %}{{ turno.paciente_dni }}{% endif %}" readonly style="width: 100%; background: #f0f0f0; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 2rem; font-weight: 700;" />
        </div>

        <!-- Campos Apellido y Nombre en la misma fila -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
            <div>
                <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Apellido</label>
                <input type="text" value="{% if paciente %}{{ paciente.apellido }}{% else %}{{ turno.apellido }}{% endif %}" readonly style="width: 100%; background: #f0f0f0; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;" />
            </div>
            <div>
                <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Nombre</label>
                <input type="text" value="{% if paciente %}{{ paciente.nombre }}{% else %}{{ turno.nombre }}{% endif %}" readonly style="width: 100%; background: #f0f0f0; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;" />
            </div>
        </div>

        <!-- Campos Fecha de Nacimiento y Sexo en la misma fila -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
            <div>
                <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Fecha de Nacimiento</label>
                <input type="date" value="{% if paciente %}{{ paciente.fecha_nacimiento|date:'Y-m-d' }}{% endif %}" style="width: 100%; background: #ffffff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;" />
            </div>
            <div>
                <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Sexo</label>
                <input type="text" value="{% if paciente %}{{ paciente.sexo }}{% endif %}" style="width: 100%; background: #ffffff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;" />
            </div>
        </div>

        <!-- Campos Tel√©fono, Email y M√©dico en una fila -->
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
            <div>
                <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Tel√©fono</label>
                <input type="tel" name="telefono" value="{% if paciente %}{{ paciente.telefono }}{% endif %}" style="width: 100%; background: #ffffff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;" />
            </div>
            <div>
                <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Email</label>
                <input type="email" name="email" value="{% if paciente %}{{ paciente.email }}{% endif %}" style="width: 100%; background: #ffffff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;" />
            </div>
            <div style="position: relative;">
                <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">M√©dico</label>
                <input type="text" id="id_medico" name="medico" value="{{ turno.medico }}" autocomplete="off" placeholder="Buscar m√©dico..." style="width: 100%; background: #ffffff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;" />
                <div id="autocompleteMedicos" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 2px solid var(--accent); border-radius: 8px; margin-top: 0.25rem; max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(200, 155, 143, 0.3);"></div>
            </div>
        </div>


        <!-- Observaciones de paciente -->
        <div style="margin-bottom: 1.5rem;">
            <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Observaciones de paciente</label>
            <input type="text" name="observaciones_paciente" value="{% if paciente %}{{ paciente.observaciones|default:'' }}{% endif %}" style="width: 100%; background: #ffffff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;" />
        </div>

        <!-- Campo Nota Interna -->
        <div style="margin-bottom: 1.5rem;">
            <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Nota Interna</label>
            <textarea name="nota_interna" rows="2" style="width: 100%; background: #ffffff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700; resize: vertical;">{{ turno.nota_interna|default:"" }}</textarea>
        </div>

        <!-- Fecha del Turno (Editable) -->
        <div style="margin-bottom: 1.5rem;">
            <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Fecha del Turno</label>
            <input type="date" name="fecha" id="id_fecha" value="{{ turno.fecha|date:'Y-m-d' }}" required style="width: 100%; background: #ffffff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;" />
        </div>

        <!-- Determinaciones -->
        <div style="margin-bottom: 1.5rem;">
            <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Determinaciones</label>
            <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 0.5rem; margin-bottom: 0.5rem;">
                <input type="text" id="inputCodigo" placeholder="C√≥digo" style="background: #ffffff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;" />
                <div style="position: relative;">
                    <input type="text" id="inputNombre" placeholder="Buscar por nombre..." autocomplete="off" style="width: 100%; background: #ffffff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;" />
                    <div id="autocompleteLista" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 2px solid var(--accent); border-radius: 8px; margin-top: 0.25rem; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(200, 155, 143, 0.3);"></div>
                </div>
                <button type="button" id="btnAgregarDet" style="padding: 0.75rem 1.5rem; background: #4caf50; color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap; font-size: 1rem;">‚ûï Agregar</button>
            </div>
            <div id="detStatus" style="margin-bottom: 0.5rem; font-size: 0.9rem;"></div>
            <div id="listaDeterminaciones" style="background: rgba(255, 255, 255, 0.15); border: 2px solid var(--accent); border-radius: 8px; padding: 1rem; min-height: 100px; max-height: 300px; overflow-y: auto;">
                <p style="color: rgba(200, 155, 143, 0.7); text-align: center; margin: 0;">No hay determinaciones agregadas</p>
            </div>
            <input type="hidden" id="id_determinaciones" name="determinaciones" value="{{ turno.determinaciones }}" />
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
            <button type="submit" style="flex: 1; padding: 0.875rem; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(200, 155, 143, 0.3);">üíæ Guardar cambios</button>
            <a href="{% url 'turnos:eliminar_turno' turno.id %}" style="flex: 1; padding: 0.875rem; background: #ff7066; color: #fff; border: none; border-radius: 8px; font-weight: 600; font-size: 1rem; text-align: center; text-decoration: none; cursor: pointer; transition: all 0.3s ease; line-height: 1.5; box-shadow: 0 2px 8px rgba(255, 112, 102, 0.3);">üóëÔ∏è Eliminar Turno</a>
            <a href="{% url 'turnos:dia' turno.fecha %}?agenda={{ turno.agenda.id }}" style="flex: 1; padding: 0.875rem; background: rgba(200, 155, 143, 0.3); color: var(--text-light); border: none; border-radius: 8px; font-weight: 600; font-size: 1rem; text-align: center; text-decoration: none; cursor: pointer; transition: all 0.3s ease; line-height: 1.5;">Cancelar</a>
        </div>
    </form>

    <div style="margin-top: 2rem;">
        <a href="{% url 'turnos:calendario' %}" style="color: var(--accent); text-decoration: none; font-weight: 600; transition: all 0.3s ease; padding: 0.5rem 1rem; border-radius: 8px; display: inline-block; background: rgba(200, 155, 143, 0.1);">‚Üê Volver al calendario</a>
    </div>
</div>

<style>
    #autocompleteLista div {
        padding: 0.75rem;
        cursor: pointer;
        transition: background 0.2s ease;
        border-bottom: 1px solid rgba(200, 155, 143, 0.2);
    }
    #autocompleteLista div:hover {
        background: rgba(200, 155, 143, 0.3);
    }
    #autocompleteLista div:last-child {
        border-bottom: none;
    }
    button[type="submit"]:hover {
        background: #b78b7f;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(200, 155, 143, 0.4);
    }
    a[href*="eliminar"]:hover {
        background: #ff5044;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 112, 102, 0.4);
    }
    a[href*="dia"]:hover, a[href*="calendario"]:hover {
        background: rgba(200, 155, 143, 0.4);
    }
</style>

<script>
let determinaciones = [];
let determinacionesCache = null;
let medicosCache = null;

// Cargar todos los m√©dicos al inicio
async function cargarMedicos() {
    if (medicosCache) return medicosCache;
    
    try {
        const response = await fetch('/turnos/api/listar-medicos/');
        medicosCache = await response.json();
        return medicosCache;
    } catch (error) {
        console.error('Error cargando m√©dicos:', error);
        return [];
    }
}

// Cargar determinaciones existentes del turno
window.addEventListener('DOMContentLoaded', async function() {
    const codigosExistentes = '{{ turno.determinaciones }}'.split(',').map(c => c.trim()).filter(c => c);
    
    if (codigosExistentes.length > 0) {
        for (const codigo of codigosExistentes) {
            try {
                const response = await fetch(`/determinaciones/api/buscar-codigo/?codigo=${encodeURIComponent(codigo)}`);
                const data = await response.json();
                
                if (data.found) {
                    if (data.tipo === 'perfil') {
                        determinaciones.push({
                            tipo: 'perfil',
                            codigo: data.codigo,
                            nombre: data.nombre,
                            determinaciones: data.determinaciones
                        });
                    } else {
                        determinaciones.push({
                            tipo: 'determinacion',
                            codigo: data.codigo,
                            nombre: data.nombre
                        });
                    }
                }
            } catch (error) {
                console.error('Error cargando determinaci√≥n:', codigo, error);
            }
        }
        actualizarListaDeterminaciones();
    }
});

// Cargar todas las determinaciones y perfiles al inicio
async function cargarDeterminaciones() {
    if (determinacionesCache) return determinacionesCache;
    
    try {
        const response = await fetch('/determinaciones/api/listar-determinaciones/');
        determinacionesCache = await response.json();
        return determinacionesCache;
    } catch (error) {
        console.error('Error cargando determinaciones:', error);
        return [];
    }
}

// Autocompletado por nombre
document.getElementById('inputNombre').addEventListener('input', async function() {
    const texto = this.value.trim().toLowerCase();
    const lista = document.getElementById('autocompleteLista');
    
    if (texto.length < 2) {
        lista.style.display = 'none';
        return;
    }
    
    const items = await cargarDeterminaciones();
    const coincidencias = items.filter(d => 
        d.nombre.toLowerCase().includes(texto)
    ).slice(0, 20);
    
    if (coincidencias.length === 0) {
        lista.style.display = 'none';
        return;
    }
    
    lista.innerHTML = coincidencias.map(item => {
        const tipoBadge = item.tipo === 'perfil' 
            ? '<span style="background: #4caf50; color: #fff; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem; font-weight: 600;">PERFIL</span>'
            : '';
        return `
            <div class="autocomplete-item" data-codigo="${item.codigo}" data-nombre="${item.nombre}" data-tipo="${item.tipo}">
                <span style="color: var(--accent); font-weight: bold; font-size: 1rem;">${item.codigo}</span> - <span style="color: var(--text-light); font-size: 1rem;">${item.nombre}</span>${tipoBadge}
            </div>
        `;
    }).join('');
    
    lista.style.display = 'block';
    
    lista.querySelectorAll('.autocomplete-item').forEach(item => {
        item.addEventListener('click', function() {
            const codigo = this.dataset.codigo;
            const nombre = this.dataset.nombre;
            document.getElementById('inputCodigo').value = codigo;
            document.getElementById('inputNombre').value = nombre;
            lista.style.display = 'none';
        });
    });
});

// Cerrar autocompletado al hacer clic fuera
document.addEventListener('click', function(e) {
    if (!e.target.closest('#inputNombre') && !e.target.closest('#autocompleteLista')) {
        document.getElementById('autocompleteLista').style.display = 'none';
    }
    if (!e.target.closest('#id_medico') && !e.target.closest('#autocompleteMedicos')) {
        document.getElementById('autocompleteMedicos').style.display = 'none';
    }
});

// Autocompletado de m√©dicos
document.getElementById('id_medico').addEventListener('input', async function() {
    const texto = this.value.trim().toLowerCase();
    const lista = document.getElementById('autocompleteMedicos');
    
    if (texto.length < 2) {
        lista.style.display = 'none';
        return;
    }
    
    const medicos = await cargarMedicos();
    const coincidencias = medicos.filter(m => 
        m.nombre_apellido.toLowerCase().includes(texto)
    ).slice(0, 15);
    
    if (coincidencias.length === 0) {
        lista.style.display = 'none';
        return;
    }
    
    lista.innerHTML = coincidencias.map(medico => {
        return `
            <div class="autocomplete-medico" data-nombre="${medico.nombre_apellido}" style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid rgba(200, 155, 143, 0.2); transition: background 0.2s;">
                <span style="color: #c89b8f; font-weight: 600;">${medico.nombre_apellido}</span>
            </div>
        `;
    }).join('');
    
    lista.style.display = 'block';
    
    lista.querySelectorAll('.autocomplete-medico').forEach(item => {
        item.addEventListener('mouseenter', function() {
            this.style.background = 'rgba(200, 155, 143, 0.2)';
        });
        item.addEventListener('mouseleave', function() {
            this.style.background = 'transparent';
        });
        item.addEventListener('click', function() {
            const nombre = this.dataset.nombre;
            document.getElementById('id_medico').value = nombre;
            lista.style.display = 'none';
        });
    });
});

// Agregar determinaci√≥n o perfil
document.getElementById('btnAgregarDet').addEventListener('click', async function() {
    const codigo = document.getElementById('inputCodigo').value.trim();
    const status = document.getElementById('detStatus');
    
    if (!codigo) {
        status.innerHTML = '<span style="color: #ff7066; font-weight: 600;">‚ö†Ô∏è Ingrese un c√≥digo</span>';
        return;
    }
    
    status.innerHTML = '<span style="color: var(--accent); font-weight: 600;">‚è≥ Buscando...</span>';
    
    try {
        const response = await fetch(`/determinaciones/api/buscar-codigo/?codigo=${encodeURIComponent(codigo)}`);
        const data = await response.json();
        
        if (data.found) {
            if (data.tipo === 'perfil') {
                // Agregar perfil completo
                const yaExiste = determinaciones.find(d => d.tipo === 'perfil' && d.codigo === data.codigo);
                if (yaExiste) {
                    status.innerHTML = '<span style="color: #ff7066; font-weight: 600;">‚ö†Ô∏è Perfil ya agregado</span>';
                    return;
                }
                
                determinaciones.push({
                    tipo: 'perfil',
                    codigo: data.codigo,
                    nombre: data.nombre,
                    determinaciones: data.determinaciones
                });
                const cantidadDets = data.determinaciones ? data.determinaciones.split(',').filter(d => d.trim()).length : 0;
                status.innerHTML = '<span style="color: #4caf50; font-weight: 600;">‚úÖ Perfil agregado (' + cantidadDets + ' determinaciones)</span>';
            } else {
                // Agregar determinaci√≥n individual
                const yaExiste = determinaciones.find(d => d.tipo === 'determinacion' && d.codigo === data.codigo);
                if (yaExiste) {
                    status.innerHTML = '<span style="color: #ff7066; font-weight: 600;">‚ö†Ô∏è Ya agregada</span>';
                    return;
                }
                
                determinaciones.push({
                    tipo: 'determinacion',
                    codigo: data.codigo,
                    nombre: data.nombre
                });
                status.innerHTML = '<span style="color: #4caf50; font-weight: 600;">‚úÖ Determinaci√≥n agregada</span>';
            }
            
            actualizarListaDeterminaciones();
            document.getElementById('inputCodigo').value = '';
            document.getElementById('inputNombre').value = '';
            setTimeout(() => status.innerHTML = '', 2000);
        } else {
            status.innerHTML = '<span style="color: #ff7066; font-weight: 600;">‚ùå C√≥digo no encontrado</span>';
        }
    } catch (error) {
        status.innerHTML = '<span style="color: #ff7066; font-weight: 600;">‚ùå Error al buscar</span>';
    }
});

// Enter para agregar determinaci√≥n
document.getElementById('inputCodigo').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('btnAgregarDet').click();
    }
});

document.getElementById('inputNombre').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('btnAgregarDet').click();
    }
});

function actualizarListaDeterminaciones() {
    const lista = document.getElementById('listaDeterminaciones');
    
    if (determinaciones.length === 0) {
        lista.innerHTML = '<p style="color: rgba(200, 155, 143, 0.7); text-align: center; margin: 0; font-weight: 600;">No hay determinaciones agregadas</p>';
    } else {
        lista.innerHTML = determinaciones.map((item, index) => {
            if (item.tipo === 'perfil') {
                return `
                    <div style="background: rgba(76, 175, 80, 0.15); border: 2px solid rgba(76, 175, 80, 0.4); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="background: #4caf50; color: #fff; padding: 0.25rem 0.6rem; border-radius: 4px; font-size: 0.75rem; font-weight: 700;">PERFIL</span>
                                <strong style="color: #4caf50; margin-left: 0.5rem; font-size: 1rem;">${item.codigo}</strong> - <span style="color: var(--text-light); font-weight: 600;">${item.nombre}</span>
                                <div style="margin-top: 0.25rem; font-size: 0.85rem; color: rgba(200, 155, 143, 0.8); font-weight: 600;">${item.determinaciones ? item.determinaciones.split(',').filter(d => d.trim()).length : 0} determinaciones</div>
                            </div>
                            <button type="button" onclick="eliminarItem(${index})" style="background: #ff7066; color: #fff; border: none; padding: 0.4rem 0.9rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.2s ease;">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(200, 155, 143, 0.15); border: 2px solid rgba(200, 155, 143, 0.3); border-radius: 8px; margin-bottom: 0.5rem;">
                        <div>
                            <strong style="color: var(--accent); font-size: 1rem;">${item.codigo}</strong> - <span style="color: var(--text-light); font-weight: 600;">${item.nombre}</span>
                        </div>
                        <button type="button" onclick="eliminarItem(${index})" style="background: #ff7066; color: #fff; border: none; padding: 0.4rem 0.9rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.2s ease;">üóëÔ∏è</button>
                    </div>
                `;
            }
        }).join('');
    }
    
    // Actualizar campo oculto con c√≥digos
    const codigos = [];
    determinaciones.forEach(item => {
        if (item.tipo === 'perfil') {
            codigos.push(item.codigo);
        } else {
            codigos.push(item.codigo.toString());
        }
    });
    document.getElementById('id_determinaciones').value = codigos.join(',');
}

function eliminarItem(index) {
    determinaciones.splice(index, 1);
    actualizarListaDeterminaciones();
}

// Cargar determinaciones al cargar la p√°gina
cargarDeterminaciones();
</script>

{% endblock %}
