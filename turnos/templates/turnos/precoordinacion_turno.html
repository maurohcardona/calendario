{% extends "base.html" %}
{% block content %}
<div style="max-width: 1100px;">
    <h2>üìù Pre-coordinaci√≥n de Turno</h2>
    <form method="post" style="background: var(--bg-card); border: 2px solid var(--accent); border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(200, 155, 143, 0.15);">
        {% csrf_token %}
        <div style="display: grid; grid-template-columns: 1.2fr 1fr; gap: 2rem;">
            <!-- Datos personales -->
            <div>
                <div style="margin-bottom: 1.2rem;">
                    <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">DNI</label>
                    <input type="text" name="dni" value="{{ paciente.dni|default:turno.dni }}" readonly style="width: 100%; background: #fff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 2rem; font-weight: 700;" required />
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.2rem;">
                    <div>
                        <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Apellido</label>
                        <input type="text" name="apellido" value="{{ paciente.apellido|default:turno.apellido }}" style="width: 100%; background: #fff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;" required />
                    </div>
                    <div>
                        <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Nombre</label>
                        <input type="text" name="nombre" value="{{ paciente.nombre|default:turno.nombre }}" style="width: 100%; background: #fff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;" required />
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.2rem;">
                    <div>
                        <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Fecha de Nacimiento</label>
                        <input type="date" name="fecha_nacimiento" value="{{ paciente.fecha_nacimiento|date:'Y-m-d' }}" style="width: 100%; background: #fff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;" />
                    </div>
                    <div>
                        <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Sexo</label>
                        <select name="sexo" style="width: 100%; background: #fff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;">
                            <option value="" {% if not paciente.sexo %}selected{% endif %}>-</option>
                            <option value="Masculino" {% if paciente.sexo == 'Masculino' %}selected{% endif %}>Masculino</option>
                            <option value="Femenino" {% if paciente.sexo == 'Femenino' %}selected{% endif %}>Femenino</option>
                            <option value="Sin asignar" {% if paciente.sexo == 'Sin asignar' %}selected{% endif %}>Sin asignar</option>
                            <option value="Desconocido" {% if paciente.sexo == 'Desconocido' %}selected{% endif %}>Desconocido</option>
                        </select>
                    </div>
                </div>
                <div style="margin-bottom: 1.2rem;">
                    <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Tel√©fono</label>
                    <input type="text" name="telefono" value="{{ paciente.telefono }}" style="width: 100%; background: #fff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;" />
                </div>
                <div style="margin-bottom: 1.2rem;">
                    <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Email</label>
                    <input type="email" name="email" value="{{ paciente.email }}" style="width: 100%; background: #fff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;" />
                </div>
                <div style="margin-bottom: 1.2rem; position: relative; display: flex; align-items: flex-end; gap: 0.5rem;">
                    <div style="flex: 1; position: relative;">
                        <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">M√©dico</label>
                        <input type="text" id="id_medico" name="medico" value="{% if turno.medico %}{{ turno.medico.nombre }}{% endif %}" autocomplete="off" placeholder="Buscar m√©dico..." style="width: 100%; background: #fff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;" />
                        <div id="autocompleteMedicos" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 2px solid var(--accent); border-radius: 8px; margin-top: 0.25rem; max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(200, 155, 143, 0.3);"></div>
                    </div>
                    <button type="button" id="btnNuevoMedico" title="Agregar m√©dico nuevo" style="height: 2.6rem; width: 2.6rem; background: #4caf50; color: #fff; border: none; border-radius: 50%; font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2); margin-bottom: 0.2rem;">+</button>
                </div>
                <div style="margin-bottom: 1.2rem;">
                    <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Observaciones</label>
                    <textarea name="observaciones_paciente" style="width: 100%; background: #fff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700; min-height: 60px;">{{ paciente.observaciones }}</textarea>
                </div>
                <div style="margin-bottom: 1.2rem;">
                    <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Nota interna</label>
                    <textarea name="nota_interna" style="width: 100%; background: #fff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700; min-height: 60px;">{{ turno.nota_interna }}</textarea>
                </div>
            </div>
            <!-- Determinaciones y datos de turno -->
            <div>
                <div style="margin-bottom: 1.2rem;">
                    <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Agenda</label>
                    <select name="agenda" id="id_agenda" required style="width: 100%; background: #fff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;">
                        {% for agenda in agendas %}
                            <option value="{{ agenda.id }}" {% if agenda.id == turno.agenda.id %}selected{% endif %}>{{ agenda.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="margin-bottom: 1.2rem;">
                    <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Fecha</label>
                    <input type="date" name="fecha" value="{{ turno.fecha|date:'Y-m-d' }}" readonly style="width: 100%; background: #f5ebe8; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700; opacity: 0.6; cursor: not-allowed;" required />
                </div>
                <div style="margin-bottom: 1.2rem;">
                    <label style="color: var(--text-light); font-weight: 600; display: block; margin-bottom: 0.5rem; font-size: 0.95rem;">Determinaciones</label>
                    <div style="display: grid; grid-template-columns: 120px 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <input type="text" id="inputCodigo" placeholder="C√≥digo" style="width: 100px; background: #ffffff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;" />
                        <div style="position: relative; width: 100%;">
                            <input type="text" id="inputNombre" placeholder="Buscar por nombre..." autocomplete="off" style="width: 100%; min-width: 300px; background: #ffffff; border: 2px solid var(--accent); color: var(--text-light); padding: 0.75rem; border-radius: 8px; font-family: inherit; font-size: 1.1rem; font-weight: 700;" />
                            <div id="autocompleteLista" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 2px solid var(--accent); border-radius: 8px; margin-top: 0.25rem; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(200, 155, 143, 0.3);"></div>
                        </div>
                        <button type="button" id="btnAgregarDet" style="padding: 0.75rem 1.5rem; background: #4caf50; color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap; font-size: 1rem;">‚ûï Agregar</button>
                    </div>
                    <div id="detStatus" style="margin-bottom: 0.5rem; font-size: 0.9rem;"></div>
                    <div id="listaDeterminaciones" style="background: rgba(255, 255, 255, 0.15); border: 2px solid var(--accent); border-radius: 8px; padding: 1rem; min-height: 300px; max-height: 700px; overflow-y: auto;">
                        <p style="color: rgba(200, 155, 143, 0.7); text-align: center; margin: 0;">No hay determinaciones agregadas</p>
                    </div>
                    <input type="hidden" id="id_determinaciones" name="determinaciones" value="{{ turno.determinaciones }}" />
                </div>
            </div>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
            <button type="button" id="btnCoordinarTurno" style="padding: 0.75rem 1.5rem; background: #1976d2; color: #fff; border: none; border-radius: 6px; font-weight: 600; font-size: 1.1rem; cursor: pointer;">Coordinar Turno</button>
            <a href="{% url 'turnos:buscar' %}" style="padding: 0.75rem 1.5rem; background: #757575; color: #fff; border: none; border-radius: 6px; font-weight: 600; font-size: 1.1rem; text-decoration: none; display: inline-block;">Cancelar</a>
        </div>
        <script>
        // ...existing code...
        document.getElementById('btnCoordinarTurno').addEventListener('click', async function() {
            const form = this.closest('form');
            const formData = new FormData(form);
            formData.append('accion', 'coordinar');
            
            // Extraer turno_id del pathname actual (ej: /turnos/turno/123/precoordinacion/)
            const pathParts = window.location.pathname.split('/');
            const turnoIdIndex = pathParts.indexOf('turno') + 1;
            const turnoId = pathParts[turnoIdIndex];
            
            // Guardar cambios primero
            const response = await fetch(window.location.pathname, {
                method: 'POST',
                headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') },
                body: formData,
                redirect: 'manual'
            });
            
            // Coordinar turno usando el turno_id extra√≠do
            const nombreImpresora = localStorage.getItem('nombre_impresora') || '';
            const coordUrl = `/turnos/turno/${turnoId}/coordinar/`;
            const coordResp = await fetch(coordUrl, {
                method: 'POST',
                headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken'), 'Content-Type': 'application/json' },
                body: JSON.stringify({ impresora: nombreImpresora })
            });
            const data = await coordResp.json();
            if (data.success) {
                // Modal de √©xito igual que buscar.html
                const modal = document.createElement('div');
                modal.id = 'modalCoordinacionExitosa';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;';
                modal.innerHTML = `
                  <div style="background: linear-gradient(135deg, #e0f7fa 0%, #b2dfdb 100%); border: 2px solid #4caf50; border-radius: 12px; padding: 2rem; max-width: 400px; box-shadow: 0 8px 32px rgba(76, 175, 80, 0.2); text-align: center;">
                    <h3 style="color: #388e3c; margin-bottom: 1rem; font-size: 1.5rem;">‚úÖ Turno coordinado exitosamente</h3>
                    <p style="color: #333; margin-bottom: 1.2rem; font-size: 1.1rem;">Mensaje generado y enviado.<br>Puede imprimir el ticket de retiro:</p>
                    <a href="/turnos/turno/${turnoId}/retiro/" target="_blank" style="background: #4caf50; color: #fff; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 1rem; display: inline-block; margin-bottom: 1rem;">üñ®Ô∏è Ticket de retiro</a>
                    <br>
                    <button onclick="window.location.href='{% url 'turnos:buscar' %}';" style="background: rgba(255,255,255,0.1); border: 1px solid #4caf50; color: #388e3c; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">Cerrar</button>
                  </div>
                `;
                document.body.appendChild(modal);
            } else {
                alert(data.error || 'Error al coordinar turno');
            }
        });
        // ...existing code...
        </script>
    <script>
    // Copia el JS de determinaciones de editar_turno.html aqu√≠
    let determinaciones = [];
    let determinacionesCache = null;

    // Cargar determinaciones existentes al cargar la p√°gina
    window.addEventListener('DOMContentLoaded', async function() {
        const codigosExistentes = '{{ turno.determinaciones }}'.split(',').map(c => c.trim()).filter(c => c);
        if (codigosExistentes.length > 0) {
            // Crear todas las promesas de fetch en paralelo
            const fetchPromises = codigosExistentes.map(codigo => 
                fetch(`/determinaciones/api/buscar-codigo/?codigo=${encodeURIComponent(codigo)}`)
                    .then(response => response.json())
                    .then(data => ({ codigo, data }))
                    .catch(error => {
                        console.error('Error cargando determinaci√≥n:', codigo, error);
                        return null;
                    })
            );
            
            // Esperar todas las respuestas en paralelo
            const resultados = await Promise.all(fetchPromises);
            
            // Procesar los resultados
            resultados.reverse().forEach(resultado => {
                if (!resultado || !resultado.data || !resultado.data.found) return;
                
                const { data } = resultado;
                if (data.tipo === 'perfil') {
                    determinaciones.unshift({
                        tipo: 'perfil',
                        codigo: data.codigo,
                        nombre: data.nombre,
                        determinaciones: data.determinaciones
                    });
                } else if (data.tipo === 'compleja') {
                    determinaciones.unshift({
                        tipo: 'compleja',
                        codigo: data.codigo,
                        nombre: data.nombre,
                        determinaciones: data.determinaciones,
                        stock: data.stock !== undefined ? data.stock : true
                    });
                } else {
                    determinaciones.unshift({
                        tipo: 'determinacion',
                        codigo: data.codigo,
                        nombre: data.nombre,
                        stock: data.stock !== undefined ? data.stock : true
                    });
                }
            });
            
            actualizarListaDeterminaciones();
        }
    });

    // Autocompletado de m√©dicos
    let medicosCache = null;
    async function cargarMedicos() {
        if (medicosCache) return medicosCache;
        try {
            const response = await fetch('/turnos/api/listar-medicos/');
            medicosCache = await response.json();
            return medicosCache;
        } catch (error) {
            console.error('Error cargando m√©dicos:', error);
            return [];
        }
    }
    
    document.getElementById('id_medico').addEventListener('input', async function() {
        const texto = this.value.trim().toLowerCase();
        const lista = document.getElementById('autocompleteMedicos');
        if (texto.length < 2) {
            lista.style.display = 'none';
            return;
        }
        const medicos = await cargarMedicos();
        const coincidencias = medicos.filter(m => 
            m.nombre_apellido.toLowerCase().includes(texto)
        ).slice(0, 15);
        if (coincidencias.length === 0) {
            lista.style.display = 'none';
            return;
        }
        lista.innerHTML = coincidencias.map(medico => {
            return `
                <div class="autocomplete-medico" data-nombre="${medico.nombre_apellido}" style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid rgba(200, 155, 143, 0.2); transition: background 0.2s;">
                    <span style="color: #c89b8f; font-weight: 600;">${medico.nombre_apellido}</span>
                    <span style="color: rgba(100, 100, 100, 0.7); font-size: 0.85rem; margin-left: 0.5rem;">MP: ${medico.matricula_provincial}</span>
                </div>
            `;
        }).join('');
        lista.style.display = 'block';
        lista.querySelectorAll('.autocomplete-medico').forEach(item => {
            item.addEventListener('mouseenter', function() {
                this.style.background = 'rgba(200, 155, 143, 0.2)';
            });
            item.addEventListener('mouseleave', function() {
                this.style.background = 'transparent';
            });
            item.addEventListener('click', function() {
                const nombre = this.dataset.nombre;
                document.getElementById('id_medico').value = nombre;
                lista.style.display = 'none';
            });
        });
    });
    
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#id_medico') && !e.target.closest('#autocompleteMedicos')) {
            document.getElementById('autocompleteMedicos').style.display = 'none';
        }
    });

    async function cargarDeterminaciones() {
        if (determinacionesCache) return determinacionesCache;
        try {
            const response = await fetch('/determinaciones/api/listar-determinaciones/');
            determinacionesCache = await response.json();
            return determinacionesCache;
        } catch (error) {
            console.error('Error cargando determinaciones:', error);
            return [];
        }
    }

    document.getElementById('inputNombre').addEventListener('input', async function() {
        const texto = this.value.trim().toLowerCase();
        const lista = document.getElementById('autocompleteLista');
        if (texto.length < 2) {
            lista.style.display = 'none';
            return;
        }
        const items = await cargarDeterminaciones();
        const coincidencias = items.filter(d => d.nombre.toLowerCase().includes(texto)).slice(0, 20);
        if (coincidencias.length === 0) {
            lista.style.display = 'none';
            return;
        }
        lista.innerHTML = coincidencias.map(item => {
            let tipoBadge = '';
            let sinStockBadge = '';
            let estiloGris = '';
            
            if (item.tipo === 'perfil') {
                tipoBadge = '<span style="background: #4caf50; color: #fff; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">PERFIL</span>';
            } else if (item.tipo === 'compleja') {
                tipoBadge = '<span style="background: #9c27b0; color: #fff; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">COMPLEJA</span>';
            }
            
            if (item.stock === false) {
                sinStockBadge = '<span style="background: #888; color: #fff; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">SIN STOCK</span>';
                estiloGris = 'opacity: 0.5;';
            }
            
            return `
                <div class="autocomplete-item" data-codigo="${item.codigo}" data-nombre="${item.nombre}" data-tipo="${item.tipo}" style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid rgba(200, 155, 143, 0.1); transition: background 0.2s; ${estiloGris}">
                    <span style="color: var(--accent); font-weight: bold;">${item.codigo}</span> - <span style="color: var(--text-light); font-weight: 600;">${item.nombre}</span>${tipoBadge}${sinStockBadge}
                </div>
            `;
        }).join('');
        lista.style.display = 'block';
        lista.querySelectorAll('.autocomplete-item').forEach(item => {
            item.addEventListener('mouseenter', function() {
                this.style.background = 'rgba(200, 155, 143, 0.2)';
            });
            item.addEventListener('mouseleave', function() {
                this.style.background = 'transparent';
            });
            item.addEventListener('click', function() {
                const codigo = this.dataset.codigo;
                const nombre = this.dataset.nombre;
                document.getElementById('inputCodigo').value = codigo;
                document.getElementById('inputNombre').value = nombre;
                lista.style.display = 'none';
            });
        });
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('#inputNombre') && !e.target.closest('#autocompleteLista')) {
            document.getElementById('autocompleteLista').style.display = 'none';
        }
    });

    document.getElementById('btnAgregarDet').addEventListener('click', async function() {
        const codigo = document.getElementById('inputCodigo').value.trim();
        const status = document.getElementById('detStatus');
        if (!codigo) {
            status.innerHTML = '<span style="color: #ff7066; font-weight: 600;">‚ö†Ô∏è Ingrese un c√≥digo</span>';
            return;
        }
        status.innerHTML = '<span style="color: var(--accent); font-weight: 600;">‚è≥ Buscando...</span>';
        try {
            const response = await fetch(`/determinaciones/api/buscar-codigo/?codigo=${encodeURIComponent(codigo)}`);
            const data = await response.json();
            if (data.found) {
                if (data.tipo === 'compleja') {
                    // Para complejas: agregar solo el c√≥digo de la compleja
                    const yaExiste = determinaciones.find(d => d.tipo === 'compleja' && d.codigo === data.codigo);
                    if (yaExiste) {
                        status.innerHTML = '<span style="color: #ff7066; font-weight: 600;">‚ö†Ô∏è Ya agregada</span>';
                        return;
                    }
                    
                    determinaciones.unshift({
                        tipo: 'compleja',
                        codigo: data.codigo,
                        nombre: data.nombre,
                        determinaciones: data.determinaciones,
                        stock: data.stock !== undefined ? data.stock : true
                    });
                    status.innerHTML = '<span style="color: #4caf50; font-weight: 600;">‚úÖ Determinaci√≥n compleja agregada</span>';
                } else if (data.tipo === 'perfil') {
                    // Para perfiles: expandir subdeterminaciones (simples o complejas)
                    const detCodesRaw = Array.isArray(data.determinaciones)
                        ? data.determinaciones
                        : (data.determinaciones || '').split(',').map(d => d.trim()).filter(Boolean);

                    if (detCodesRaw.length === 0) {
                        status.innerHTML = '<span style="color: #ff7066; font-weight: 600;">‚ö†Ô∏è El perfil no tiene determinaciones</span>';
                        return;
                    }

                    const catalogo = await cargarDeterminaciones();
                    let agregadas = 0;

                    for (const code of detCodesRaw) {
                        // Si comienza con /, es una determinaci√≥n compleja
                        if (code.startsWith('/')) {
                            const yaExisteCompleja = determinaciones.find(d => d.tipo === 'compleja' && d.codigo === code);
                            if (yaExisteCompleja) continue;
                            
                            // Buscar la determinaci√≥n compleja en el cat√°logo
                            const itemCompleja = catalogo.find(d => d.codigo === code && d.tipo === 'compleja');
                            if (itemCompleja) {
                                determinaciones.unshift({
                                    tipo: 'compleja',
                                    codigo: itemCompleja.codigo,
                                    nombre: itemCompleja.nombre,
                                    determinaciones: itemCompleja.determinaciones,
                                    stock: itemCompleja.stock !== undefined ? itemCompleja.stock : true
                                });
                                agregadas += 1;
                            }
                        } else {
                            // Es una determinaci√≥n simple
                            const yaExisteDet = determinaciones.find(d => d.tipo === 'determinacion' && d.codigo === code);
                            if (yaExisteDet) continue;
                            
                            const itemCat = catalogo.find(d => d.codigo === code && d.tipo === 'determinacion');
                            const nombreDet = itemCat ? itemCat.nombre : code;
                            determinaciones.unshift({
                                tipo: 'determinacion',
                                codigo: code,
                                nombre: nombreDet,
                                stock: itemCat && itemCat.stock !== undefined ? itemCat.stock : true
                            });
                            agregadas += 1;
                        }
                    }

                    if (agregadas === 0) {
                        status.innerHTML = '<span style="color: #ff7066; font-weight: 600;">‚ö†Ô∏è Todas las determinaciones del perfil ya estaban agregadas</span>';
                    } else {
                        status.innerHTML = `<span style="color: #4caf50; font-weight: 600;">‚úÖ Perfil agregado (${agregadas} determinaciones)</span>`;
                    }
                } else {
                    // Determinaci√≥n simple
                    const yaExiste = determinaciones.find(d => d.tipo === 'determinacion' && d.codigo === data.codigo);
                    if (yaExiste) {
                        status.innerHTML = '<span style="color: #ff7066; font-weight: 600;">‚ö†Ô∏è Ya agregada</span>';
                        return;
                    }
                    determinaciones.unshift({
                        tipo: 'determinacion',
                        codigo: data.codigo,
                        nombre: data.nombre,
                        stock: data.stock !== undefined ? data.stock : true
                    });
                    status.innerHTML = '<span style="color: #4caf50; font-weight: 600;">‚úÖ Determinaci√≥n agregada</span>';
                }
                actualizarListaDeterminaciones();
                document.getElementById('inputCodigo').value = '';
                document.getElementById('inputNombre').value = '';
                setTimeout(() => status.innerHTML = '', 2000);
            } else {
                status.innerHTML = '<span style="color: #ff7066; font-weight: 600;">‚ùå C√≥digo no encontrado</span>';
            }
        } catch (error) {
            status.innerHTML = '<span style="color: #ff7066; font-weight: 600;">‚ùå Error al buscar</span>';
        }
    });

    document.getElementById('inputCodigo').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('btnAgregarDet').click();
        }
    });
    document.getElementById('inputNombre').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('btnAgregarDet').click();
        }
    });

    function actualizarListaDeterminaciones() {
        const lista = document.getElementById('listaDeterminaciones');
        if (determinaciones.length === 0) {
            lista.innerHTML = '<p style="color: rgba(200, 155, 143, 0.7); text-align: center; margin: 0; font-weight: 600;">No hay determinaciones agregadas</p>';
        } else {
            lista.innerHTML = determinaciones.map((item, index) => {
                if (item.tipo === 'perfil') {
                    return `
                        <div style="background: rgba(76, 175, 80, 0.15); border: 2px solid rgba(76, 175, 80, 0.4); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="background: #4caf50; color: #fff; padding: 0.25rem 0.6rem; border-radius: 4px; font-size: 0.75rem; font-weight: 700;">PERFIL</span>
                                    <strong style="color: #4caf50; margin-left: 0.5rem; font-size: 1rem;">${item.codigo}</strong> - <span style="color: var(--text-light); font-weight: 600;">${item.nombre}</span>
                                    <div style="margin-top: 0.25rem; font-size: 0.85rem; color: rgba(200, 155, 143, 0.8); font-weight: 600;">${(item.determinaciones && typeof item.determinaciones === 'string') ? item.determinaciones.split(',').filter(d => d.trim()).length : 0} determinaciones</div>
                                </div>
                                <button type="button" class="btn-eliminar" data-index="${index}" style="background: #ff7066; color: #fff; border: none; padding: 0.4rem 0.9rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.2s ease;">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                } else if (item.tipo === 'compleja') {
                    const sinStockBadge = item.stock === false ? '<span style="background: #888; color: #fff; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem; font-weight: 700;">SIN STOCK</span>' : '';
                    const estiloGris = item.stock === false ? 'opacity: 0.6;' : '';
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(156, 39, 176, 0.15); border: 2px solid rgba(156, 39, 176, 0.3); border-radius: 8px; margin-bottom: 0.5rem; ${estiloGris}">
                            <div>
                                <span style="background: #9c27b0; color: #fff; padding: 0.25rem 0.6rem; border-radius: 4px; font-size: 0.75rem; font-weight: 700;">COMPLEJA</span>
                                <strong style="color: #9c27b0; margin-left: 0.5rem; font-size: 1rem;">${item.codigo}</strong> - <span style="color: var(--text-light); font-weight: 600;">${item.nombre}</span>${sinStockBadge}
                            </div>
                            <button type="button" class="btn-eliminar" data-index="${index}" style="background: #ff7066; color: #fff; border: none; padding: 0.4rem 0.9rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.2s ease;">üóëÔ∏è</button>
                        </div>
                    `;
                } else {
                    const sinStockBadge = item.stock === false ? '<span style="background: #888; color: #fff; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem; font-weight: 700;">SIN STOCK</span>' : '';
                    const estiloGris = item.stock === false ? 'opacity: 0.6;' : '';
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(200, 155, 143, 0.15); border: 2px solid rgba(200, 155, 143, 0.3); border-radius: 8px; margin-bottom: 0.5rem; ${estiloGris}">
                            <div>
                                <strong style="color: var(--accent); font-size: 1rem;">${item.codigo}</strong> - <span style="color: var(--text-light); font-weight: 600;">${item.nombre}</span>${sinStockBadge}
                            </div>
                            <button type="button" class="btn-eliminar" data-index="${index}" style="background: #ff7066; color: #fff; border: none; padding: 0.4rem 0.9rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.2s ease;">üóëÔ∏è</button>
                        </div>
                    `;
                }
            }).join('');
            
            // Event delegation para botones de eliminar
            lista.querySelectorAll('.btn-eliminar').forEach(btn => {
                btn.addEventListener('click', function() {
                    eliminarItem(parseInt(this.dataset.index));
                });
            });
        }
        // Actualizar campo oculto con c√≥digos
        const codigos = [];
        determinaciones.forEach(item => {
            if (item.tipo === 'perfil' || item.tipo === 'compleja') {
                codigos.push(item.codigo);
            } else {
                codigos.push(item.codigo.toString());
            }
        });
        document.getElementById('id_determinaciones').value = codigos.join(',');
    }
    function eliminarItem(index) {
        determinaciones.splice(index, 1);
        actualizarListaDeterminaciones();
    }
    cargarDeterminaciones();
    </script>

    </form>
</div>

<!-- Modal para agregar m√©dico nuevo -->
<div id="modalNuevoMedico" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:12px; padding:2rem; max-width:400px; margin:auto; box-shadow:0 8px 32px rgba(0,0,0,0.3); position:relative;">
        <button id="cerrarModalMedico" style="position:absolute; top:0.5rem; right:0.5rem; background:none; border:none; font-size:1.5rem; color:#888; cursor:pointer;">&times;</button>
        <h3 style="margin-top:0; color:#4caf50;">Agregar nuevo m√©dico</h3>
        <form id="formNuevoMedico">
            <div style="margin-bottom:1rem;">
                <label for="nombreMedico" style="font-weight:600;">Apellido y Nombre</label>
                <input type="text" id="nombreMedico" name="nombreMedico" required style="width:100%; padding:0.5rem; border-radius:6px; border:1px solid #ccc;" />
            </div>
            <div style="margin-bottom:1.5rem;">
                <label for="matriculaMedico" style="font-weight:600;">Matr√≠cula Provincial</label>
                <input type="text" id="matriculaMedico" name="matriculaMedico" required style="width:100%; padding:0.5rem; border-radius:6px; border:1px solid #ccc;" />
            </div>
            <button type="submit" style="background:#4caf50; color:#fff; border:none; border-radius:8px; padding:0.7rem 1.5rem; font-weight:700; font-size:1rem; cursor:pointer; width:100%;">Guardar m√©dico</button>
            <div id="estadoNuevoMedico" style="margin-top:1rem; font-size:0.95rem;"></div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnNuevoMedico = document.getElementById('btnNuevoMedico');
    const modalNuevoMedico = document.getElementById('modalNuevoMedico');
    const cerrarModalMedico = document.getElementById('cerrarModalMedico');
    const formNuevoMedico = document.getElementById('formNuevoMedico');
    const estadoNuevoMedico = document.getElementById('estadoNuevoMedico');

    // Verificar que todos los elementos existen
    if (!btnNuevoMedico || !modalNuevoMedico || !cerrarModalMedico || !formNuevoMedico || !estadoNuevoMedico) {
        console.error('Modal elements not found:', {
            btnNuevoMedico: !!btnNuevoMedico,
            modalNuevoMedico: !!modalNuevoMedico,
            cerrarModalMedico: !!cerrarModalMedico,
            formNuevoMedico: !!formNuevoMedico,
            estadoNuevoMedico: !!estadoNuevoMedico
        });
        return;
    }

    btnNuevoMedico.addEventListener('click', function() {
        modalNuevoMedico.style.display = 'flex';
        estadoNuevoMedico.textContent = '';
        formNuevoMedico.reset();
    });
    cerrarModalMedico.addEventListener('click', function() {
        modalNuevoMedico.style.display = 'none';
    });
    modalNuevoMedico.addEventListener('click', function(e) {
        if (e.target === modalNuevoMedico) {
            modalNuevoMedico.style.display = 'none';
        }
    });
    formNuevoMedico.addEventListener('submit', async function(e) {
        e.preventDefault();
        const nombre = document.getElementById('nombreMedico').value.trim();
        const matricula = document.getElementById('matriculaMedico').value.trim();
        if (!nombre || !matricula) {
            estadoNuevoMedico.textContent = 'Complete ambos campos.';
            estadoNuevoMedico.style.color = '#d32f2f';
            return;
        }
        estadoNuevoMedico.textContent = 'Guardando...';
        estadoNuevoMedico.style.color = '#333';
        try {
            const response = await fetch('/turnos/api/crear-medico/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ nombre_apellido: nombre, matricula_provincial: matricula })
            });
            const data = await response.json();
            if (data.success) {
                estadoNuevoMedico.textContent = 'M√©dico guardado correctamente.';
                estadoNuevoMedico.style.color = '#388e3c';
                // Actualizar cache y autocompletado
                if (typeof medicosCache !== 'undefined') medicosCache = null;
                if (typeof cargarMedicos === 'function') await cargarMedicos();
                document.getElementById('id_medico').value = nombre;
                setTimeout(() => { modalNuevoMedico.style.display = 'none'; }, 1000);
            } else {
                estadoNuevoMedico.textContent = data.error || 'Error al guardar.';
                estadoNuevoMedico.style.color = '#d32f2f';
            }
        } catch (err) {
            estadoNuevoMedico.textContent = 'Error de red.';
            estadoNuevoMedico.style.color = '#d32f2f';
        }
    });
});
</script>

{% endblock %}

