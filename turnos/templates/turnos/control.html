{% extends "base.html" %}
{% block content %}
<style>
    :root {
        --control-primary: #00d4ff;
        --control-success: #4caf50;
        --control-warning: #ff9800;
        --control-danger: #f44336;
        --control-bg: #faf6f4;
    }
    
    .control-header {
        background: linear-gradient(135deg, var(--control-bg) 0%, #f5ebe8 100%);
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        border: 2px solid var(--control-primary);
        box-shadow: 0 4px 12px rgba(0, 212, 255, 0.2);
    }
    
    .orden-card {
        background: #ffffff;
        border: 2px solid rgba(0, 212, 255, 0.3);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .orden-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid rgba(0, 212, 255, 0.2);
    }
    
    .paciente-info {
        flex: 1;
    }
    
    .paciente-nombre {
        font-size: 1.5rem;
        font-weight: 700;
        color: #000000;
        margin-bottom: 0.25rem;
    }
    
    .paciente-dni {
        font-size: 1rem;
        color: var(--text-medium);
        font-weight: 500;
    }
    
    .determinacion-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: rgba(200, 155, 143, 0.1);
        border: 2px solid rgba(200, 155, 143, 0.3);
        border-radius: 8px;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .determinacion-item.checked {
        background: rgba(76, 175, 80, 0.15);
        border-color: var(--control-success);
    }
    
    .determinacion-item.extra {
        background: rgba(255, 152, 0, 0.15);
        border-color: var(--control-warning);
    }
    
    .det-info {
        flex: 1;
    }
    
    .det-badge {
        padding: 0.25rem 0.6rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 700;
        color: #fff;
        margin-right: 0.5rem;
    }
    
    .badge-perfil { background: #4caf50; }
    .badge-compleja { background: #9c27b0; }
    .badge-simple { background: var(--accent); }
    
    .det-codigo {
        font-weight: 700;
        color: var(--text-light);
        font-size: 1rem;
    }
    
    .det-nombre {
        color: var(--text-medium);
        font-weight: 500;
    }
    
    .btn-extra {
        padding: 0.5rem 1rem;
        background: var(--control-warning);
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-extra:hover {
        background: #f57c00;
        transform: translateY(-2px);
    }
    
    .agregar-faltante {
        margin-top: 1rem;
        padding: 1rem;
        background: rgba(33, 150, 243, 0.1);
        border: 2px dashed #2196f3;
        border-radius: 8px;
    }
    
    .btn-agregar {
        padding: 0.5rem 1rem;
        background: #2196f3;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        margin-top: 0.5rem;
    }
    
    .btn-siguiente {
        padding: 1rem 2rem;
        background: var(--control-primary);
        color: #000;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1.1rem;
        margin-top: 1.5rem;
        width: 100%;
        transition: all 0.3s ease;
    }
    
    .btn-siguiente:hover {
        background: #00a8cc;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 212, 255, 0.4);
    }
    
    .resumen-final {
        background: linear-gradient(135deg, #f5ebe8 0%, #faf6f4 100%);
        border: 3px solid var(--control-primary);
        border-radius: 12px;
        padding: 2rem;
        margin-top: 2rem;
    }
    
    .resumen-section {
        margin-bottom: 1.5rem;
    }
    
    .resumen-title {
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--text-light);
    }
    
    .resumen-item {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 6px;
        font-weight: 500;
    }
    
    .resumen-extra {
        background: rgba(255, 152, 0, 0.2);
        border-left: 4px solid var(--control-warning);
    }
    
    .resumen-faltante {
        background: rgba(244, 67, 54, 0.2);
        border-left: 4px solid var(--control-danger);
    }
    
    .orden-contador {
        background: var(--control-primary);
        color: #000;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 700;
        font-size: 1rem;
    }
</style>

<div class="control-header">
    <h2 style="margin: 0; font-size: 2.5rem; font-weight: 700; color: #000000;">‚úÖ Control de √ìrdenes</h2>
    <p style="margin: 0.5rem 0 0 0; color: var(--text-medium); font-size: 1.1rem; font-weight: 500;">Fecha: {{ fecha|date:"d/m/Y" }} | Total de √≥rdenes: <strong>{{ total_ordenes }}</strong></p>
</div>

{% if ordenes %}
<div id="ordenes-container">
    {% for orden in ordenes %}
    <div class="orden-card" data-orden-index="{{ forloop.counter0 }}" data-paciente-dni="{{ orden.turno.paciente_dni }}" style="display: {% if forloop.first %}block{% else %}none{% endif %};">
        <div class="orden-header">
            <div class="paciente-info">
                <div class="paciente-nombre">{{ orden.turno.apellido }}, {{ orden.turno.nombre }}</div>
                <div class="paciente-dni">DNI: {{ orden.turno.paciente_dni }}</div>
                <div style="color: var(--text-medium); font-size: 0.9rem; margin-top: 0.25rem;">
                    Agenda: <strong>{{ orden.turno.agenda.name }}</strong>
                    {% if orden.turno.medico %}| M√©dico: <strong>{{ orden.turno.medico.nombre }}</strong>{% endif %}
                </div>
            </div>
            <div class="orden-contador">
                Orden <span class="orden-actual">1</span> de {{ total_ordenes }}
            </div>
        </div>
        
        <div style="margin-bottom: 1rem;">
            <h3 style="color: var(--text-light); font-size: 1.2rem; font-weight: 700; margin-bottom: 0.75rem;">Determinaciones</h3>
            <div class="determinaciones-list">
                {% for det in orden.determinaciones %}
                <div class="determinacion-item" data-codigo="{{ det.codigo }}" onclick="toggleDeterminacion(this)">
                    {% if det.tipo == 'perfil' %}
                    <span class="det-badge badge-perfil">PERFIL</span>
                    {% elif det.tipo == 'compleja' %}
                    <span class="det-badge badge-compleja">COMPLEJA</span>
                    {% else %}
                    <span class="det-badge badge-simple">DET</span>
                    {% endif %}
                    <div class="det-info">
                        <span class="det-codigo">{{ det.codigo }}</span> - <span class="det-nombre">{{ det.nombre }}</span>
                        {% if det.tipo == 'perfil' and det.determinaciones %}
                        <div style="margin-top: 0.25rem; font-size: 0.85rem; color: rgba(200, 155, 143, 0.8);">
                            {{ det.determinaciones|slice:":100" }}{% if det.determinaciones|length > 100 %}...{% endif %}
                        </div>
                        {% endif %}
                    </div>
                    <button type="button" class="btn-extra" onclick="marcarExtra(event, this)">‚ùå Est√° de m√°s</button>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="agregar-faltante">
            <h4 style="color: #2196f3; font-weight: 700; margin-bottom: 0.5rem;">‚ûï Agregar determinaci√≥n faltante</h4>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: flex-start;">
                <input type="text" class="input-codigo-faltante" placeholder="C√≥digo" style="width: 15%; padding: 0.75rem; border: 2px solid #2196f3; border-radius: 6px; font-size: 1rem;">
                <div style="position: relative; flex: 1;">
                    <input type="text" class="input-nombre-faltante" placeholder="Buscar por nombre..." style="width: 100%; padding: 0.75rem; border: 2px solid #2196f3; border-radius: 6px; font-size: 1rem;">
                    <div class="autocomplete-lista-faltante" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: #ffffff; border: 2px solid #2196f3; border-radius: 8px; margin-top: 0.25rem; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);"></div>
                </div>
                <button type="button" class="btn-agregar" onclick="agregarFaltante(this)" style="padding: 0.75rem 1.5rem; background: #2196f3; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">Agregar</button>
            </div>
            <div class="mensaje-error-faltante" style="color: #f44336; font-weight: 600; margin-bottom: 0.5rem; min-height: 1.5rem;"></div>
            <div class="lista-faltantes" style="margin-top: 1rem;"></div>
        </div>
        
        <button type="button" class="btn-siguiente" onclick="siguienteOrden()">
            {% if forloop.last %}
            üèÅ Finalizar y Ver Resumen
            {% else %}
            ‚û°Ô∏è Siguiente Orden
            {% endif %}
        </button>
    </div>
    {% endfor %}
</div>

<div id="resumen-final" class="resumen-final" style="display: none;">
    <h2 style="margin: 0 0 1.5rem 0; font-size: 2rem; font-weight: 700; color: #000000;">üìä Resumen de Control</h2>
    
    <div class="resumen-section">
        <div id="resumen-ordenes"></div>
    </div>
    
    <button onclick="window.location.reload()" style="padding: 1rem 2rem; background: var(--control-success); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1.1rem; width: 100%;">
        üîÑ Nuevo Control
    </button>
</div>

{% else %}
<div style="text-align: center; padding: 3rem; background: rgba(200, 155, 143, 0.1); border-radius: 12px; border: 2px dashed rgba(200, 155, 143, 0.3);">
    <p style="font-size: 1.3rem; color: var(--text-medium); font-weight: 600;">No hay √≥rdenes coordinadas para el d√≠a de hoy</p>
</div>
{% endif %}

<script>
let ordenActual = 0;
const totalOrdenes = {{ total_ordenes }};
const resultados = {
    extras: [],
    faltantes: []
};
let determinacionesCache = null;

// Cargar todas las determinaciones
async function cargarDeterminaciones() {
    if (determinacionesCache) return determinacionesCache;
    
    try {
        const response = await fetch('/determinaciones/api/listar-determinaciones/');
        determinacionesCache = await response.json();
        return determinacionesCache;
    } catch (error) {
        console.error('Error cargando determinaciones:', error);
        return [];
    }
}

function toggleDeterminacion(item) {
    // No hacer nada si ya est√° marcada como extra
    if (item.classList.contains('extra')) {
        return;
    }
    
    // Toggle clase checked
    item.classList.toggle('checked');
}

function marcarExtra(event, btn) {
    event.stopPropagation(); // Evitar que se active toggleDeterminacion
    
    const item = btn.closest('.determinacion-item');
    const codigo = item.dataset.codigo;
    const texto = item.querySelector('.det-info').textContent.trim();
    const ordenCard = item.closest('.orden-card');
    const ordenIndex = ordenCard.dataset.ordenIndex;
    const pacienteDni = ordenCard.dataset.pacienteDni;
    
    if (!item.classList.contains('extra')) {
        item.classList.add('extra');
        item.classList.remove('checked');
        btn.textContent = '‚úì Marcado de m√°s';
        btn.style.background = 'var(--control-success)';
        
        // Agregar al resumen
        resultados.extras.push({
            orden: parseInt(ordenIndex) + 1,
            dni: pacienteDni,
            codigo: codigo,
            texto: texto
        });
    } else {
        item.classList.remove('extra');
        btn.textContent = '‚ùå Est√° de m√°s';
        btn.style.background = 'var(--control-warning)';
        
        // Quitar del resumen
        resultados.extras = resultados.extras.filter(e => !(e.codigo === codigo && e.orden === parseInt(ordenIndex) + 1));
    }
}

function agregarFaltante(btn) {
    const container = btn.closest('.agregar-faltante');
    const inputCodigo = container.querySelector('.input-codigo-faltante');
    const inputNombre = container.querySelector('.input-nombre-faltante');
    const mensajeError = container.querySelector('.mensaje-error-faltante');
    const codigo = inputCodigo.value.trim();
    const nombre = inputNombre.value.trim();
    
    // Limpiar mensaje de error previo
    mensajeError.textContent = '';
    
    if (!codigo) {
        mensajeError.textContent = '‚ö†Ô∏è Ingrese un c√≥digo de determinaci√≥n';
        return;
    }
    
    const ordenCard = btn.closest('.orden-card');
    const ordenIndex = ordenCard.dataset.ordenIndex;
    const pacienteDni = ordenCard.dataset.pacienteDni;
    
    // Validar que no est√© ya en la orden actual
    const determinacionesExistentes = ordenCard.querySelectorAll('.determinacion-item');
    const yaExiste = Array.from(determinacionesExistentes).some(det => 
        det.dataset.codigo === codigo
    );
    
    if (yaExiste) {
        mensajeError.textContent = '‚ö†Ô∏è Determinaci√≥n ya cargada en esta orden';
        return;
    }
    
    // Buscar informaci√≥n de la determinaci√≥n
    fetch(`/determinaciones/api/buscar-codigo/?codigo=${encodeURIComponent(codigo)}`)
        .then(response => response.json())
        .then(data => {
            if (!data.found) {
                mensajeError.textContent = '‚ùå C√≥digo incorrecto';
                return;
            }
            
            const nombreDet = data.nombre || nombre || codigo;
            const lista = container.querySelector('.lista-faltantes');
            
            // Crear elemento visual con c√≥digo y nombre
            const div = document.createElement('div');
            div.className = 'resumen-item resumen-faltante';
            div.innerHTML = '<strong>' + codigo + '</strong> - ' + nombreDet + ' <button onclick="quitarFaltante(this, \'' + codigo + '\')" style="float: right; background: var(--control-danger); color: #fff; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">Quitar</button>';
            lista.appendChild(div);
            
            // Agregar al resumen
            resultados.faltantes.push({
                orden: parseInt(ordenIndex) + 1,
                dni: pacienteDni,
                codigo: codigo,
                nombre: nombreDet
            });
            
            // Limpiar campos
            inputCodigo.value = '';
            inputNombre.value = '';
            mensajeError.textContent = '';
        })
        .catch(error => {
            console.error('Error buscando c√≥digo:', error);
            mensajeError.textContent = '‚ùå Error al buscar determinaci√≥n';
        });
}

function quitarFaltante(btn, codigo) {
    const ordenIndex = btn.closest('.orden-card').dataset.ordenIndex;
    btn.closest('.resumen-item').remove();
    
    // Quitar del resumen
    resultados.faltantes = resultados.faltantes.filter(f => !(f.codigo === codigo && f.orden === parseInt(ordenIndex) + 1));
}

function siguienteOrden() {
    const ordenes = document.querySelectorAll('.orden-card');
    
    // Ocultar orden actual
    ordenes[ordenActual].style.display = 'none';
    
    // Incrementar contador
    ordenActual++;
    
    if (ordenActual < totalOrdenes) {
        // Mostrar siguiente orden
        ordenes[ordenActual].style.display = 'block';
        
        // Actualizar contador
        document.querySelectorAll('.orden-actual').forEach(el => {
            el.textContent = ordenActual + 1;
        });
        
        // Scroll al inicio
        window.scrollTo(0, 0);
    } else {
        // Mostrar resumen final
        mostrarResumen();
    }
}

function mostrarResumen() {
    document.getElementById('ordenes-container').style.display = 'none';
    const resumen = document.getElementById('resumen-final');
    resumen.style.display = 'block';
    
    // Combinar todos los hallazgos y ordenar por n√∫mero de orden
    const todosLosHallazgos = [];
    
    // Agregar extras
    resultados.extras.forEach(e => {
        todosLosHallazgos.push({
            orden: e.orden,
            dni: e.dni,
            tipo: 'extra',
            texto: e.texto
        });
    });
    
    // Agregar faltantes
    resultados.faltantes.forEach(f => {
        todosLosHallazgos.push({
            orden: f.orden,
            dni: f.dni,
            tipo: 'faltante',
            codigo: f.codigo,
            nombre: f.nombre
        });
    });
    
    // Ordenar por n√∫mero de orden
    todosLosHallazgos.sort((a, b) => a.orden - b.orden);
    
    // Mostrar resumen ordenado
    const ordenesDiv = document.getElementById('resumen-ordenes');
    if (todosLosHallazgos.length > 0) {
        ordenesDiv.innerHTML = todosLosHallazgos.map(item => {
            if (item.tipo === 'extra') {
                return '<div class="resumen-item resumen-extra">' +
                    '<strong>Orden ' + item.orden + ' (DNI: ' + item.dni + '):</strong> ' +
                    '<span style="color: var(--control-warning);">‚ö†Ô∏è DE M√ÅS:</span> ' + item.texto +
                    '</div>';
            } else {
                return '<div class="resumen-item resumen-faltante">' +
                    '<strong>Orden ' + item.orden + ' (DNI: ' + item.dni + '):</strong> ' +
                    '<span style="color: var(--control-danger);">üî¥ FALTANTE:</span> <strong>' + item.codigo + '</strong> - ' + item.nombre +
                    '</div>';
            }
        }).join('');
    } else {
        ordenesDiv.innerHTML = '<p style="color: var(--text-medium); font-style: italic; text-align: center; padding: 2rem; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">‚úÖ No se encontraron diferencias. Todas las √≥rdenes est√°n correctas.</p>';
    }
    
    // Scroll al inicio
    window.scrollTo(0, 0);
}

// Configurar autocompletado para cada orden
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.orden-card').forEach(ordenCard => {
        const inputNombre = ordenCard.querySelector('.input-nombre-faltante');
        const inputCodigo = ordenCard.querySelector('.input-codigo-faltante');
        const lista = ordenCard.querySelector('.autocomplete-lista-faltante');
        const btnAgregar = ordenCard.querySelector('.btn-agregar');
        
        if (!inputNombre || !lista) return;
        
        // Enter en campo de c√≥digo para agregar
        inputCodigo.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                btnAgregar.click();
            }
        });
        
        // Enter en campo de nombre para agregar
        inputNombre.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                btnAgregar.click();
            }
        });
        
        // Autocompletado por nombre
        inputNombre.addEventListener('input', async function() {
            const texto = this.value.trim().toLowerCase();
            
            if (texto.length < 2) {
                lista.style.display = 'none';
                return;
            }
            
            const items = await cargarDeterminaciones();
            const coincidencias = items.filter(d => 
                d.nombre.toLowerCase().includes(texto) || d.codigo.toLowerCase().includes(texto)
            ).slice(0, 20);
            
            if (coincidencias.length === 0) {
                lista.style.display = 'none';
                return;
            }
            
            lista.innerHTML = coincidencias.map(item => {
                let tipoBadge = '';
                let sinStockBadge = '';
                let estiloGris = '';
                
                if (item.tipo === 'perfil') {
                    tipoBadge = '<span style="background: #4caf50; color: #fff; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">PERFIL<\/span>';
                } else if (item.tipo === 'compleja') {
                    tipoBadge = '<span style="background: #9c27b0; color: #fff; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">COMPLEJA<\/span>';
                }
                
                if (item.stock === false) {
                    sinStockBadge = '<span style="background: #888; color: #fff; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">SIN STOCK<\/span>';
                    estiloGris = 'opacity: 0.5;';
                }
                
                return '<div class="autocomplete-item" data-codigo="' + item.codigo + '" data-nombre="' + item.nombre + '" style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid rgba(33, 150, 243, 0.1); transition: background 0.2s; ' + estiloGris + '">' +
                    '<span style="color: #2196f3; font-weight: bold;">' + item.codigo + '<\/span> - <span style="color: #000; font-weight: 600;">' + item.nombre + '<\/span>' + tipoBadge + sinStockBadge +
                    '<\/div>';
            }).join('');
            
            lista.style.display = 'block';
            
            lista.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('mouseenter', function() {
                    this.style.background = 'rgba(33, 150, 243, 0.1)';
                });
                item.addEventListener('mouseleave', function() {
                    this.style.background = 'transparent';
                });
                item.addEventListener('click', function() {
                    inputCodigo.value = this.dataset.codigo;
                    inputNombre.value = this.dataset.nombre;
                    lista.style.display = 'none';
                });
            });
        });
        
        // Cerrar autocompletado al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.input-nombre-faltante') && !e.target.closest('.autocomplete-lista-faltante')) {
                lista.style.display = 'none';
            }
        });
    });
});
</script>

{% endblock %}
