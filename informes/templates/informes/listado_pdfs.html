{% extends 'base.html' %}

{% block content %}
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
  <h2 style="margin:0; font-size:2rem; font-weight:700; color:#000;">üìÑ Informes PDF</h2>
</div>

<form method="get" style="display:flex; gap:0.75rem; margin-bottom:1.5rem; align-items:center;">
  <input
    type="text"
    name="q"
    value="{{ termino_busqueda }}"
    placeholder="Buscar por nombre de PDF..."
    style="flex:1; max-width:420px; padding:0.6rem 0.8rem; border:1px solid #ccc; border-radius:8px;"
  >
  <button type="submit" style="background:#c89b8f; color:#fff; border:none; padding:0.6rem 1rem; border-radius:8px; font-weight:600;">Buscar</button>
  {% if termino_busqueda %}
    <a href="{% url 'informes:listado' %}" style="text-decoration:none; color:#555; font-weight:600;">Limpiar</a>
  {% endif %}
</form>

<div id="mail-processing-banner" style="display:none; margin-bottom:1rem; padding:0.75rem 1rem; border-radius:8px; background:rgba(200,155,143,0.2); border:1px solid rgba(200,155,143,0.5); color:#6a3f32; font-weight:600;">
  ‚è≥ Procesando env√≠o de correo, por favor espere...
</div>

<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); gap:1.5rem;">
  <section style="background:#fff; border:2px solid rgba(143, 184, 143, 0.4); border-radius:10px; padding:1rem;">
    <h3 style="margin-bottom:1rem; color:#2f6b2f;">‚úÖ Enviados ({{ total_enviados }})</h3>
    {% if pdfs_enviados %}
      <ul style="padding-left:1rem; margin:0; display:grid; gap:0.5rem;">
        {% for archivo in pdfs_enviados %}
          <li style="display:flex; align-items:center; justify-content:space-between; gap:0.75rem;">
            <a href="{% url 'informes:ver_pdf' 'enviados' archivo %}" target="_blank" style="text-decoration:none; color:#0d6efd;">
              {{ archivo }}
            </a>
            <form method="post" action="{% url 'informes:enviar_informe' 'enviados' archivo %}" style="margin:0;" data-mail-submit="true" data-confirm-message="¬øConfirmas volver a enviar este informe?">
              {% csrf_token %}
              <input type="hidden" name="q" value="{{ termino_busqueda }}">
              <input type="hidden" name="page_enviados" value="{{ page_enviados_actual }}">
              <input type="hidden" name="page_pendientes" value="{{ page_pendientes_actual }}">
              <button type="submit" data-loading-text="Reenviando..." style="background:#2f6b2f; color:#fff; border:none; border-radius:6px; padding:0.35rem 0.65rem; font-size:0.85rem; font-weight:600; cursor:pointer;">Volver a enviar</button>
            </form>
          </li>
        {% endfor %}
      </ul>
      {% if pdfs_enviados.paginator.num_pages > 1 %}
        <div style="display:flex; gap:0.6rem; align-items:center; margin-top:1rem; flex-wrap:wrap;">
          {% if pdfs_enviados.has_previous %}
            <a href="?q={{ termino_busqueda|urlencode }}&page_enviados={{ pdfs_enviados.previous_page_number }}&page_pendientes={{ page_pendientes_actual }}" style="text-decoration:none; color:#0d6efd; font-weight:600;">‚Üê Anterior</a>
          {% endif %}
          <span style="color:#666;">P√°gina {{ pdfs_enviados.number }} de {{ pdfs_enviados.paginator.num_pages }}</span>
          {% if pdfs_enviados.has_next %}
            <a href="?q={{ termino_busqueda|urlencode }}&page_enviados={{ pdfs_enviados.next_page_number }}&page_pendientes={{ page_pendientes_actual }}" style="text-decoration:none; color:#0d6efd; font-weight:600;">Siguiente ‚Üí</a>
          {% endif %}
        </div>
      {% endif %}
    {% else %}
      {% if termino_busqueda %}
        <p style="margin:0; color:#666;">No se encontraron PDFs enviados para "{{ termino_busqueda }}".</p>
      {% else %}
        <p style="margin:0; color:#666;">No hay PDFs enviados.</p>
      {% endif %}
    {% endif %}
  </section>

  <section style="background:#fff; border:2px solid rgba(232, 184, 143, 0.5); border-radius:10px; padding:1rem;">
    <h3 style="margin-bottom:1rem; color:#a25f24;">‚è≥ Pendientes ({{ total_pendientes }})</h3>
    {% if pdfs_pendientes %}
      <ul style="padding-left:1rem; margin:0; display:grid; gap:0.5rem;">
        {% for archivo in pdfs_pendientes %}
          <li style="display:flex; align-items:center; justify-content:space-between; gap:0.75rem;">
            <a href="{% url 'informes:ver_pdf' 'pendientes' archivo %}" target="_blank" style="text-decoration:none; color:#0d6efd;">
              {{ archivo }}
            </a>
            <form method="post" action="{% url 'informes:enviar_informe' 'pendientes' archivo %}" style="margin:0;" data-mail-submit="true" data-confirm-message="¬øConfirmas enviar este informe?">
              {% csrf_token %}
              <input type="hidden" name="q" value="{{ termino_busqueda }}">
              <input type="hidden" name="page_enviados" value="{{ page_enviados_actual }}">
              <input type="hidden" name="page_pendientes" value="{{ page_pendientes_actual }}">
              <button type="submit" data-loading-text="Enviando..." style="background:#a25f24; color:#fff; border:none; border-radius:6px; padding:0.35rem 0.65rem; font-size:0.85rem; font-weight:600; cursor:pointer;">Enviar</button>
            </form>
          </li>
        {% endfor %}
      </ul>
      {% if pdfs_pendientes.paginator.num_pages > 1 %}
        <div style="display:flex; gap:0.6rem; align-items:center; margin-top:1rem; flex-wrap:wrap;">
          {% if pdfs_pendientes.has_previous %}
            <a href="?q={{ termino_busqueda|urlencode }}&page_enviados={{ page_enviados_actual }}&page_pendientes={{ pdfs_pendientes.previous_page_number }}" style="text-decoration:none; color:#0d6efd; font-weight:600;">‚Üê Anterior</a>
          {% endif %}
          <span style="color:#666;">P√°gina {{ pdfs_pendientes.number }} de {{ pdfs_pendientes.paginator.num_pages }}</span>
          {% if pdfs_pendientes.has_next %}
            <a href="?q={{ termino_busqueda|urlencode }}&page_enviados={{ page_enviados_actual }}&page_pendientes={{ pdfs_pendientes.next_page_number }}" style="text-decoration:none; color:#0d6efd; font-weight:600;">Siguiente ‚Üí</a>
          {% endif %}
        </div>
      {% endif %}
    {% else %}
      {% if termino_busqueda %}
        <p style="margin:0; color:#666;">No se encontraron PDFs pendientes para "{{ termino_busqueda }}".</p>
      {% else %}
        <p style="margin:0; color:#666;">No hay PDFs pendientes.</p>
      {% endif %}
    {% endif %}
  </section>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const formularios = document.querySelectorAll('form[data-mail-submit="true"]');

    formularios.forEach(function (formulario) {
      formulario.addEventListener('submit', function (event) {
        const mensaje = formulario.getAttribute('data-confirm-message');
        if (mensaje && !window.confirm(mensaje)) {
          event.preventDefault();
          return;
        }

        const boton = formulario.querySelector('button[type="submit"]');
        if (!boton) {
          return;
        }

        if (boton.disabled) {
          event.preventDefault();
          return;
        }

        const textoCarga = boton.getAttribute('data-loading-text') || 'Enviando...';
        const banner = document.getElementById('mail-processing-banner');
        if (banner) {
          banner.style.display = 'block';
        }
        boton.disabled = true;
        boton.textContent = '‚è≥ ' + textoCarga;
        boton.style.opacity = '0.8';
        boton.style.cursor = 'not-allowed';
      });
    });
  });
</script>
{% endblock %}
